[TOC]



# 问题

## 所属权判断

> 当key-value通过命令在某个redis集群节点中执行时 set/get/exists等等。
>
> 当前节点作为集群一员，不会和数据做强耦合。需要计算key对应的槽道号，得到0-16383整数，然后判断槽道管理权。做后续决定管理权如何进行判断。
>
> 例如：name-->5798当前节点怎么就能知道5798归不归他管？

## 节点信息的存储

> 对于任意一个集群节点，有办法判断所属权。当判断槽道不归当前节点管理时，当前节点又如何知道正确节点的信息，进行客户端重定向？？？
>
> 例如：8000接收到name的key值，计算槽道5798 得到槽道管理权，false，如何拿到8001节点信息。



# 槽道原理

## 判断所属权

1. 在每个节点加入到集群后，节点会因集群的状态而变化。对于节点都会维护一个==16384位的二进制==：本质上是一个byte数组 

   > byte[2048]数组：一个元素8位 ，2048个元素就是16384位的二进制。==在每个节点中都会在内存里**保存该节点的这个二进制**==

2. 对二进制进行计算可以得到每个位置上的`0|1`的值，同时人为定义，对二进制做位移等计算可以得到从0到16383二进制下标号，从而对应槽道号。换句话，任何一个槽道号，都能从这个二进制中拿到一个二进制下标对应值(每一个槽道号都对应一个16384位2进制下标号)

   ![](https://gitee.com/sxhDrk/images/raw/master/imgs/节点信息的存储-节点对象1.png)

   > 当某一个节点在内存中有二进制值的时候，可以利用对二进制下标的定义，对应到槽道号。
   >
   > 可以对key值在该节点做槽道计算之后
   >
   > - 通过槽道号，找到二进制值。
   > - 判断所属权。
   >   - 当二进制是1时，所属权是true  该槽道归当前节点管理
   >   - 当二进制是0时，所属权是false 该槽道不归当前节点管理。

3. 当前集群中二进制特点

   > 当前集群结构：
   >
   > - 8000master：0-5460
   >
   >   0-5460下标的二进制为1，其他的都为0
   >
   > - 8001master：5461-10922
   >
   >   5461-10922下标的二进制为1，其他位都为0
   >
   > - 8002master：10923-16384
   >
   >   10923-16384下标的二进制为1，其他位都为0

   ![](https://gitee.com/sxhDrk/images/raw/master/imgs/槽道原理-当前节点二进制结构.png)

   > 在一个正常集群中，每一个槽道对应的二进制值，只能有一个节点中的是1，其他节点该槽道对应下标的二进制都是0
   >
   > 管理槽道逻辑的数据，从具备主节点的二进制值中备份。在计算时，不是用节点中的这个二进制，而是用备份的数据

### 为什么槽道号是16384，不是65536等其他数

> 因为是两两互联，节点与节点之间的数据传递的协议中，定义了数据头，包含槽道信息，大小限制2kb。
>
> - 大了会导致传递信息速度的下降
> - 小了会导致数据信息携带不够。

![](https://gitee.com/sxhDrk/images/raw/master/imgs/槽道原理-为什么是16384.png)



## 节点信息的存储

1. 创建集群时，相互通信初始化内容

   > 没有创建集群时，登录节点可以看到该节点的信息，这些信息都会保存在当前内存中的一个节点对象中

   ![](https://gitee.com/sxhDrk/images/raw/master/imgs/槽道原理-判断所属权1.png)

   

   > 图解：

   ![](https://gitee.com/sxhDrk/images/raw/master/imgs/节点信息的存储-节点对象4.png)

   > 在没有创建集群，没有相互连接通信时，单个节点中就只保存了当前节点的详细信息

   ![](https://gitee.com/sxhDrk/images/raw/master/imgs/节点信息的存储-节点对象3.png)

   > 执行创建集群的过程就是相互通信建立的过程
   >
   > 当建立完集群，相互信息传递两两通信之后，所有节点中保存的本节点数据都会传递到其他节点中，每一个节点都保存了当前集群里所有节点的信息。登录任何一节点，调用`cluster nodes`时就能看到所有信息。

   ![](https://gitee.com/sxhDrk/images/raw/master/imgs/节点信息的存储-节点对象2.png)

   

   
   
2. 每个节点具备访问其他节点信息的数据

   > 解决槽道第二个问题：**获取槽道正确管理者信息**。
   >
   > 还需要一个数据保存槽道与节点的对应关系---==共享数组==
   >
   > 相互通过二进制底层协议传输数据时，每个节点中都已经具备所有节点对象，通过二进制中携带的值判断，生成对应共享数组
   >
   > - 共享数组下标对应槽道号
   >   - 8001槽道号：5461-10922，那么共享数组[5461-10922]下标对应的值都是一个变量（var8001）,指向内存对应的节点对象
   >   - 当key经过槽道计算，得出一个一个槽道值，先判断是否属于自己管理
   >     - 属于自己管理，就直接处理
   >     - 不属于自己管理，通过共享数组，找到槽道值对应下标的变量，找到节点对象，获取节点信息，进行转发

   ![](https://gitee.com/sxhDrk/images/raw/master/imgs/节点信息的存储-共享数组1.png)

   

   > 每个节点中，在创建完集群都会生成一个数组对象，数组有16384个元素（下标对应槽道号）。
   >
   > 最终生成的数组元素值==特点==是：==下标号对应槽道==，该槽道所属的节点是谁，就可以通过对数组元素获取拿到这个正确管理节点的对象信息。所以所有节点都应该保存一个完全一样的数组对象，无论从哪个节点进行数据命令调用，都可以通过数组找对正确管理者

   ![](https://gitee.com/sxhDrk/images/raw/master/imgs/节点信息的存储-共享数组2.png)



# 总结

1. 所属权

   槽道管理必须引入所属权逻辑，没有所属权判断，一定不会找到节点存储数据。 二进制作为一个16384位的值，可以为0-16383下标号做bit存储，每一位的值是1表示所属，是0表示不所属，通过下标计算刚好对应所有的槽道号

2. 节点信息获取

   在每一个节点中都会保存一个完全一样的数组，数组元素个数16384，下标刚好对应槽道，利用槽道下标，保存该槽道管理节点信息到元素中，每个元素都是一个变量，指向了内存中一个节点对象（只要下标对应元素指向某个节点，表示该下标槽道号对应这个节点处理）





